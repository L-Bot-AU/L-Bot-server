{% extends "librarian_base.html" %}

{% block page_title %}Edit{% endblock %}

{% block page_content %}
	<button type="button" class="focusbtn settab" onclick="setFocus('general', this)">General</button>
	<button type="button" class="focusbtn" onclick="setFocus('events', this)">Events</button>
	<button type="button" class="focusbtn" onclick="setFocus('alerts', this)">Alerts</button><br><br>
	<div id="notification" hidden style="background-color: #1b9420; color: white; position: fixed; z-index: 100; top: 90px; right: 20px;  border-radius: 5px; padding: 12px">
		<i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-check-circle"></i>
	 	Your changes have been saved!
	</div>
	<table class="edit-tabwrapper"><tr valign="top">
	<!-- GENERAL -->
	<th class="tab generaltab">
	<div class="form-inline edit-line">
    <label class="bold-this edit-label" for="day"> Day: </label>
	<select class="form-control edit-input" onchange="changeTimes(this)" id="day" name="day" required>
		<option value="Monday"> Monday </option>
		<option value="Tuesday"> Tuesday </option>
		<option value="Wednesday"> Wednesday </option>
		<option value="Thursday"> Thursday </option>
		<option value="Friday"> Friday </option>
	</select>
	</div>
	<div class="form-inline edit-line">
	<label class="bold-this edit-label" for="openingTime"> Opening time: </label>
	<input type="time" class="form-control edit-input" id="openingTime" name="openingTime" onchange=changeOpening(this) required>
	</div>
	<div class="form-inline edit-line">
	<label class="bold-this edit-label" for="openingTime"> Closing time: </label>
	<input type="time" class="form-control edit-input" id="closingTime" name="closingTime" onchange=changeClosing(this) required>
	</div>
	<div class="form-inline edit-line">
	<label class="bold-this edit-label" for="maxSeats"> Maximum seats: </label>
	<input style="width: 80px; margin-right: 170px; display: inline" type="number" class="form-control" id="maxSeats" name="maxSeats" value={{ max_seats }} required>
	</div>
	<div class="edit-line" style="width: 364px; margin: auto; margin-top: 20px;"> <label style=" text-align: left; margin-right: 300px; padding-right: 10px" class="bold-this edit-label"> Librarians: </label><br>
	<div id="librarians">
		{% for librarian in librarians %}
			<li class="edit-list-line bold-this"> <input class="form-control edit-list" type="text" value="{{ librarian.name }}"> <button class="btn btn-primary remove-button" onclick=this.parentElement.remove()> <i style="font-family: 'Font Awesome 5 Pro' !important; color: white;" class="fas fa-times-circle"> </i> Remove </button></li>
		{% endfor %}
	</div>
	<button style="margin-left: -292px; margin-top: 20px; margin-bottom: 20px;" class="btn btn-primary submit-button" onclick="addLibrarian(this.parentElement)"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-plus-circle"></i> Add </button>
	</div>
	<button class="btn btn-primary save-button" style="margin-right: 112px;" onclick="saveGeneral()"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-check-circle"></i> Save changes </button><button class="btn btn-primary remove-button" onclick=window.location.reload()> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-redo-alt"></i> Cancel changes </button>
	</th>
	
	<!-- EVENTS TAB -->
	<th class="tab eventstab">
	<ul class="key list" style="font-weight: normal">
		<li class="highimpact"> High impact </li>
		<li class="moderateimpact"> Moderate impact </li>
		<li class="lowimpact"> Low impact </li>
	</ul>
	<ul class="list" id="events">
		{% for event in events %}
			<li data-bs-placement="left" class="edit-hover {{ event.impact }}impact bold-this" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-html="true" data-bs-content="<ul class='list'><li class='highimpact impact-choice'></li><li class='moderateimpact impact-choice'></li><li class='lowimpact impact-choice'></li></ul>"> <input class="form-control edit-event" type="text" value="{{ event.event }}"> <button class="btn btn-primary remove-button" onclick=this.parentElement.remove()> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-times-circle"></i> Remove </button></li>
		{% endfor %}
	</ul>
	<button style="margin-left: -15px; margin-top: 20px; margin-bottom: 20px;" class="btn btn-primary submit-button" onclick="addEvent()"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-plus-circle"></i> Add </button><br>
	<button class="btn btn-primary save-button" style="margin-left: -15px; margin-right: 10px;" onclick="saveEvents()"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-check-circle"></i> Save changes </button><button class="btn btn-primary remove-button" onclick="window.location.reload()"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-redo-alt"></i> Cancel changes </button>
	</th>
	
	<!-- ALERTS TAB -->
	<th class="tab alertstab">
	<ul class="alert-list" id="alerts">
		{% for alert in alerts %}
			<li data-bs-placement="left" class="form-inline bold-this" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-html="true" data-bs-content="<div class='list'><span class='impact-choice'>⚠</span><br><span class='impact-choice'>ℹ</span><br></div>"><div class="alert-icon">{{'⚠' if alert.type == "warning" else 'ℹ' }}</div><textarea class="form-control alert-box"> {{ alert.alert }} </textarea><button class="btn btn-primary remove-button" onclick=this.parentElement.remove()> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-times-circle"></i> Remove </button></li>
		{% endfor %}
	</ul>
	<button style="margin-left: -15px; margin-top: 20px; margin-bottom: 20px;" class="btn btn-primary submit-button" onclick="addAlert()"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-plus-circle"></i> Add </button><br>
	<button class="btn btn-primary save-button" style="margin-left: -15px; margin-right: 10px;" onclick=saveAlerts()> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-check-circle"></i> Save changes </button><button class="btn btn-primary remove-button" onclick="window.location.reload()"> <i style='font-family: "Font Awesome 5 Pro" !important; color: white;' class="fas fa-redo-alt"></i> Cancel changes </button>
	</th>
	</tr></table>
	<script>
		var opening_times = {{ opening_times | safe }};
		var closing_times = {{ closing_times | safe }};
		
		var currentDay = new Date().getDay() - 1;
		if (currentDay == -1 || currentDay == 5) {
			currentDay = 0;
		}
		var selectedDay = document.getElementById("day");
		selectedDay.value = [...selectedDay.options].map(option => option.value)[currentDay];
		changeTimes(day);
		[...document.getElementById("events").children].forEach(event => {
			event.onclick = function() {
				window.currentSelected = event;
				document.querySelectorAll(".impact-choice").forEach(choice => {
					choice.onclick = function() {setImpact(choice)};
				});
			};
		});
		[...document.getElementById("alerts").children].forEach(alert => {
			alert.onclick = function() {
				window.currentSelected = alert;
				document.querySelectorAll(".impact-choice").forEach(choice => {
					choice.onclick = function() {
						choice.onclick = setImportance(choice);
					}
				});
			}
		});
		var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
		var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
			return new bootstrap.Popover(popoverTriggerEl);
		});

		function setFocus(newFocus, obj) {
			document.getElementsByClassName("settab")[0].classList.remove("settab");
			obj.classList.add("settab");
			switch (newFocus) {
				case "general":
					document.body.classList.remove("focuscenter");
					document.body.classList.remove("focusright");
					break;
				case "events":
					document.body.classList.remove("focusright");
					document.body.classList.add("focuscenter");
					break;
				case "alerts":
					document.body.classList.remove("focuscenter");
					document.body.classList.add("focusright");
					break;
			}
		}
		
		function changeTimes(dayElement) {
			var day = dayElement.value.toLowerCase();
			var openingTime = document.getElementById("openingTime");
			var closingTime = document.getElementById("closingTime");
			openingTime.value = opening_times[day].map(num => String(num).padStart(2, '0')).join(":");
			closingTime.value = closing_times[day].map(num => String(num).padStart(2, '0')).join(":");
		}
		
		function changeOpening(openingElement) {
			var day = document.getElementById("day").value.toLowerCase();
			opening_times[day] = openingElement.value.split(":").map(num => parseInt(num));
		}
		
		function changeClosing(closingElement) {
			var day = document.getElementById("day").value.toLowerCase();
			closing_times[day] = closingElement.value.split(":").map(num => parseInt(num));
		}
		
		function addLibrarian() {
			var librarians = document.getElementById("librarians");
			var newLib = document.createElement("li");
			newLib.classList.add("edit-list-line", "bold-this");
			var libInput = document.createElement("input");
			libInput.classList.add("form-control", "edit-list");
			libInput.setAttribute("type", "text");
			var removeButton = document.createElement("button");
			removeButton.classList.add("btn", "btn-primary", "remove-button");
			removeButton.setAttribute("onclick", "this.parentElement.remove()");
			var removeIcon = document.createElement("i");
			removeIcon.setAttribute("style", "font-family: \'Font Awesome 5 Pro\' !important; color: white;");
			removeIcon.classList.add("fas", "fa-times-circle");
			removeButton.appendChild(removeIcon);
			removeButton.appendChild(document.createTextNode(" Remove"));
			newLib.appendChild(libInput);
			newLib.appendChild(document.createTextNode(" "));
			newLib.appendChild(removeButton);
			librarians.appendChild(newLib);
		}
		
		function addEvent() {
			var events = document.getElementById("events");
			var newEvent = document.createElement("li");
			newEvent.classList.add("edit-hover", "lowimpact", "bold-this");
			newEvent.setAttribute("data-bs-toggle", "popover");
			newEvent.setAttribute("data-bs-trigger", "focus");
			newEvent.setAttribute("data-bs-placement", "left");
			newEvent.setAttribute("data-bs-html", "true");
			newEvent.setAttribute("data-bs-content", "<ul class='list'><li class='highimpact impact-choice'></li><li class='moderateimpact impact-choice'></li><li class='lowimpact impact-choice'></li></ul>");
			var eventInput = document.createElement("input");
			eventInput.classList.add("form-control", "edit-event");
			eventInput.setAttribute("type", "text");
			var removeButton = document.createElement("button");
			removeButton.classList.add("btn", "btn-primary", "remove-button");
			removeButton.setAttribute("onclick", "this.parentElement.remove()");
			var removeIcon = document.createElement("i");
			removeIcon.setAttribute("style", "font-family: \'Font Awesome 5 Pro\' !important; color: white;");
			removeIcon.classList.add("fas", "fa-times-circle");
			removeButton.appendChild(removeIcon);
			removeButton.appendChild(document.createTextNode(" Remove"));
			newEvent.appendChild(eventInput);
			newEvent.appendChild(document.createTextNode(" "));
			newEvent.appendChild(removeButton);
			events.appendChild(newEvent);
			var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
			var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
			  return new bootstrap.Popover(popoverTriggerEl);
			});
			newEvent.onclick = function() {
				window.currentSelected = newEvent;
				document.querySelectorAll(".impact-choice").forEach(choice => {
					choice.onclick = function() {setImpact(choice)};
				});
			}
		}
		
		function addAlert() {
			var alerts = document.getElementById("alerts");
			var newAlert = document.createElement("li");
			newAlert.classList.add("form-inline", "bold-this");
			newAlert.setAttribute("data-bs-toggle", "popover");
			newAlert.setAttribute("data-bs-trigger", "focus");
			newAlert.setAttribute("data-bs-placement", "left");
			newAlert.setAttribute("data-bs-html", "true");
			newAlert.setAttribute("data-bs-content", "<div class='list'><span class='impact-choice'>⚠</span><br><span class='impact-choice'>ℹ</span><br></div>");
			var alertIcon = document.createElement("div");
			alertIcon.classList.add("alert-icon");
			alertIcon.appendChild(document.createTextNode("⚠"));
			var alertText = document.createElement("textarea");
			alertText.classList.add("form-control", "alert-box");
			var removeButton = document.createElement("button");
			removeButton.classList.add("btn", "btn-primary", "remove-button");
			removeButton.setAttribute("onclick", "this.parentElement.remove()");
			var removeIcon = document.createElement("i");
			removeIcon.setAttribute("style", "font-family: \'Font Awesome 5 Pro\' !important; color: white;");
			removeIcon.classList.add("fas", "fa-times-circle");
			removeButton.appendChild(removeIcon);
			removeButton.appendChild(document.createTextNode(" Remove"));
			newAlert.appendChild(alertIcon);
			newAlert.appendChild(alertText);
			newAlert.appendChild(document.createTextNode(" "));
			newAlert.appendChild(removeButton);
			alerts.appendChild(newAlert);
			var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
			var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
			  return new bootstrap.Popover(popoverTriggerEl);
			});
			newAlert.onclick = function() {
				window.currentSelected = newAlert;
				document.querySelectorAll(".impact-choice").forEach(choice => {
					choice.onclick = function() {
						choice.onclick = setImportance(choice);
					}
				});
			}
		}
		
		function setImpact(impactType) {
			window.currentSelected.className = impactType.classList[0];
		}

		function setImportance(importanceType) {
			window.currentSelected.children[0].innerHTML = importanceType.innerHTML;
		}
		
		function saveGeneral() {
			/* Code for manually sending a POST request: https://stackoverflow.com/questions/6396101/pure-javascript-send-post-data-without-a-form */
			var xhr = new XMLHttpRequest();
			var librarians = [];
			var max_seats = document.getElementById("maxSeats").value;
			[...document.getElementById("librarians").children].forEach(l => {
				librarians.push(l.children[0].value);
			});
			xhr.open("POST", "", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			
			xhr.onreadystatechange = function() {
				if (this.readyState === 4 && this.status === 200) {
					showNotification("Your changes have been changed!");
				}
			}
			
			xhr.send(JSON.stringify({
				tab: "general",
				opening_times: opening_times,
				closing_times: closing_times,
				max_seats: parseInt(max_seats),
				librarians: librarians
			}));
		}
		
		function saveEvents() {
			var xhr = new XMLHttpRequest();
			var events = [];
			var event;
			var impact;
			[...document.getElementById("events").children].forEach(l => {
				if (l.classList.contains("lowimpact")) {
					impact = "low";
				} else if (l.classList.contains("moderateimpact")) {
					impact = "moderate";
				} else {
					impact = "high";
				}
				event = {
					impact: impact,
					event: l.children[0].value
				};
				events.push(event);
			});
			xhr.open("POST", "", true);
			xhr.setRequestHeader("Content-Type", "application/json");
			
			xhr.onreadystatechange = function() {
				if (this.readyState === 4 && this.status === 200) {
					showNotification("Your changes have been changed!");
				}
			}
			
			xhr.send(JSON.stringify({
				tab: "events",
				events: events
			}));
		}

		function saveAlerts() {
			var xhr = new XMLHttpRequest();
			var alerts = [];
			var alert;
			var importance;
			[...document.getElementById("alerts").children].forEach (l => {
				if (l.children[0].innerHTML === "⚠") {
					importance = "warning";
				} else {
					importance = "information";
				}
				alert = {
					importance: importance,
					alert: l.children[1].value
				};
				alerts.push(alert);
			})
			xhr.open("POST", "", true);
			xhr.setRequestHeader("Content-Type", "application/json");

			xhr.onreadystatechange = function() {
				if (this.readyState === 4 && this.status === 200) {
					showNotification("Your changes have been changed!");
				}
			}
			
			xhr.send(JSON.stringify({
				tab: "alerts",
				alerts: alerts
			}));
		}

		function showNotification(message) {
			console.log("a");
			var notif = document.getElementById("notification");
			console.log(notif);
			notif.hidden = false;
			notif.innerHTML = "<i style='font-family: \"Font Awesome 5 Pro\" !important; color: white;' class=\"fas fa-check-circle\"></i> " + message;
			setTimeout(function() {
			    notif.hidden = true;
			}, 3000);
			console.log(notif);
		}
			
	</script>
{% endblock %}